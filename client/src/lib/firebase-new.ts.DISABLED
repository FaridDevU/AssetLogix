import { initializeApp, getApps, getApp } from "firebase/app";
import { getAuth, GoogleAuthProvider, signInWithPopup, User as FirebaseUser } from "firebase/auth";

// Tipo personalizado para GoogleUser
export interface GoogleUser extends FirebaseUser {
  email: string;
  displayName: string | null;
  uid: string;
}

// ğŸ§ª FIREBASE CONDICIONALMENTE DESHABILITADO - OpciÃ³n 1 implementada
let firebaseApp: any = null;
let auth: any = null;
let provider: GoogleAuthProvider | null = null;

if (
  import.meta.env.VITE_FIREBASE_API_KEY &&
  import.meta.env.VITE_FIREBASE_AUTH_DOMAIN &&
  import.meta.env.VITE_FIREBASE_PROJECT_ID &&
  import.meta.env.VITE_FIREBASE_STORAGE_BUCKET &&
  import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID &&
  import.meta.env.VITE_FIREBASE_APP_ID &&
  import.meta.env.VITE_FIREBASE_API_KEY !== "your_firebase_api_key" // Evitar claves placeholder
) {
  console.log("âœ… Variables de Firebase vÃ¡lidas encontradas - inicializando Firebase");
  
  const firebaseConfig = {
    apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
    authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
    projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
    storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
    messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
    appId: import.meta.env.VITE_FIREBASE_APP_ID,
    measurementId: import.meta.env.VITE_FIREBASE_MEASUREMENT_ID
  };

  firebaseApp = getApps().length > 0 ? getApp() : initializeApp(firebaseConfig);
  auth = getAuth(firebaseApp);
  provider = new GoogleAuthProvider();
} else {
  console.warn("ğŸš« Variables de Firebase ausentes o usando placeholders - modo desarrollo sin autenticaciÃ³n");
}

// FunciÃ³n para autenticar con Google usando Popup
export const signInWithGoogle = async (): Promise<GoogleUser> => {
  if (!auth || !provider) {
    console.warn("ğŸš« Firebase no inicializado - retornando usuario demo");
    return {
      uid: "demo-uid",
      email: "demo@company.com",
      displayName: "Usuario Demo"
    } as GoogleUser;
  }

  try {
    console.log("ğŸ” Iniciando autenticaciÃ³n con Google...");
    const result = await signInWithPopup(auth, provider);
    
    if (!result.user || !result.user.email) {
      throw new Error("No se pudo obtener un correo electrÃ³nico vÃ¡lido de Google");
    }
    
    console.log("âœ… Usuario autenticado con Ã©xito:", result.user);
    return result.user as GoogleUser;
  } catch (error) {
    console.error("âŒ Error en autenticaciÃ³n con Google:", error);
    throw error;
  }
};

// FunciÃ³n para autenticar con Google usando Redirect
export const signInWithGoogleRedirect = async () => {
  console.warn("ğŸš« signInWithGoogleRedirect deshabilitado");
  throw new Error("Firebase deshabilitado");
};

// FunciÃ³n para manejar el resultado de la redirecciÃ³n
export const handleGoogleRedirect = async (): Promise<GoogleUser | null> => {
  console.warn("ğŸš« handleGoogleRedirect deshabilitado");
  return null;
};

// FunciÃ³n para obtener la informaciÃ³n del usuario actual
export const getCurrentUser = (): Promise<GoogleUser | null> => {
  return new Promise((resolve) => {
    if (!auth) {
      console.warn("ğŸš« Firebase no inicializado - getCurrentUser retorna null");
      resolve(null);
      return;
    }
    
    const unsubscribe = auth.onAuthStateChanged((user: any) => {
      unsubscribe();
      resolve(user);
    });
  });
};

// FunciÃ³n para cerrar sesiÃ³n
export const signOut = () => {
  if (!auth) {
    console.warn("ğŸš« Firebase no inicializado - signOut simulado");
    return Promise.resolve();
  }
  
  return auth.signOut();
};

// Aliases para backward compatibility
export const loginWithGoogle = signInWithGoogle;
export const handleRedirectResult = handleGoogleRedirect;

// Login con email (implementaciÃ³n dummy para compatibilidad)
export const loginWithEmail = async (email: string, password: string) => {
  throw new Error("Email login not implemented in this version");
};

// Export auth (puede ser null si Firebase no estÃ¡ inicializado)
export { auth };
